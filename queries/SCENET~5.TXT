WITH D1(INCIDENT_CD, ARVSCN_DATE, ARVSCN_TIME, DPTSCN_DATE, DPTSCN_TIME) AS (
SELECT 	INCIDENT_CD, ARVSCN_DATE, ARVSCN_TIME,  DPTSCN_DATE, DPTSCN_TIME
FROM 	FACCSDB.INCIDENT_UNITS_AL1 
WHERE 	ARVSCN_DATE BETWEEN DATE('01/31/1999') AND DATE('03/05/1999') AND TYPE_CD = 'BLS'),

D2(INCIDENT_CD) AS (
SELECT INCIDENT_CD FROM FACCSDB.INCIDENT_UNITS_AL1 WHERE ARVSCN_DATE BETWEEN DATE('01/31/1999') AND DATE('03/05/1999') AND TYPE_CD = 'ALS'),

D3(INCIDENT_CD) AS (
SELECT DISTINCT D1.INCIDENT_CD FROM D1,D2  WHERE D1.INCIDENT_CD = D2.INCIDENT_CD),

ALSARV(INCIDENT_CD, TIMES) AS (
SELECT  	U.INCIDENT_CD, MIN(TIMESTAMP(U.ARVSCN_DATE, U.ARVSCN_TIME))
FROM 	FACCSDB.INCIDENT_UNITS_AL1 U, D3 D 
WHERE 	U.INCIDENT_CD = D.INCIDENT_CD 	AND 
	U.TYPE_CD = 'ALS'			
GROUP BY U.INCIDENT_CD),

ILSARV(INCIDENT_CD, TIMES) AS (
SELECT  	D.INCIDENT_CD, MIN(TIMESTAMP(D.ARVSCN_DATE, D.ARVSCN_TIME))
FROM 	D1 D 
GROUP BY D.INCIDENT_CD),

ILSDPT(INCIDENT_CD, TIMES) AS (
SELECT  	D.INCIDENT_CD, MIN(TIMESTAMP(D.DPTSCN_DATE, D.DPTSCN_TIME))
FROM 	D1 D 
GROUP BY D.INCIDENT_CD),

ALSDPT(INCIDENT_CD, TIMES) AS (
SELECT  	U.INCIDENT_CD, MIN(TIMESTAMP(U.DPTSCN_DATE, U.DPTSCN_TIME))
FROM 	FACCSDB.INCIDENT_UNITS_AL1 U, D3 D 
WHERE 	U.INCIDENT_CD = D.INCIDENT_CD 	AND 
	U.TYPE_CD = 'BLS'			
GROUP BY U.INCIDENT_CD),

ALSSCNTM (ALSATSCN, INCIDENT_CD, DIAG_CD) AS (
SELECT 	TIMESTAMPDIFF(2, CAST((AA.TIMES) - AD.TIMES AS CHAR(22))) AS ALSATSCN,
	AA.INCIDENT_CD,
	P.DIAG_CD
FROM 	ALSARV AA, ALSDPT AD, FACCSDB.PATIENTS1 P, FACCSDB.DIAGCODES D
WHERE	AA.INCIDENT_CD = AD.INCIDENT_CD	AND
	P.INCIDENT_CD = AA.INCIDENT_CD 	AND
	P.DIAG_CD IN D.DIAG_CD),

ILSSCNTM (ILSATSCN, INCIDENT_CD, DIAG_CD) AS (
SELECT 	TIMESTAMPDIFF(2, CAST((AA.TIMES) - AD.TIMES AS CHAR(22))) AS ILSATSCN,
	AA.INCIDENT_CD,
	P.DIAG_CD
FROM 	ILSARV AA, ILSDPT AD, FACCSDB.PATIENTS1 P, FACCSDB.DIAGCODES D
WHERE	AA.INCIDENT_CD = AD.INCIDENT_CD	AND
	P.INCIDENT_CD = AA.INCIDENT_CD 	AND
	P.DIAG_CD IN D.DIAG_CD),

INNERJOIN (INCIDENT_CD, ALSATSCN, ILSATSCN, DIAG_CD) AS
(SELECT A.INCIDENT_CD,
	ALSATSCN, 
	ILSATSCN,
	A.DIAG_CD
 FROM 	ALSSCNTM A, 
	ILSSCNTM I 
 WHERE 	A.INCIDENT_CD=I.INCIDENT_CD),

RIGHTOUTERJOIN (INCIDENT_CD, ILSATSCN, DIAG_CD) AS
(SELECT I.INCIDENT_CD, I.ILSATSCN,  I.DIAG_CD FROM ILSSCNTM I
 EXCEPT ALL
 SELECT INCIDENT_CD, ILSATSCN, DIAG_CD FROM INNERJOIN),

LEFTOUTERJOIN (INCIDENT_CD, ALSATSCN, DIAG_CD) AS
(SELECT A.INCIDENT_CD, A.ALSATSCN,  A.DIAG_CD FROM ALSSCNTM A
 EXCEPT ALL
 SELECT INCIDENT_CD, ALSATSCN, DIAG_CD FROM INNERJOIN),


RESULTABLE (INCIDENT_CD, ALS_SCN, ILS_SCN, DIAG_CD) AS
(
SELECT INCIDENT_CD, ALSATSCN AS ALS_SCN, ILSATSCN AS ILS_SCN, DIAG_CD FROM INNERJOIN
UNION ALL
SELECT	INCIDENT_CD		AS INCIDENT_CD,
	ALSATSCN		AS ALS_SCN,
	CAST(NULL AS INTEGER) 	AS ILS_SCN,
	DIAG_CD 		AS DIAG_CD
FROM	LEFTOUTERJOIN     
UNION ALL
SELECT 	INCIDENT_CD		AS INCIDENT_CD,
	CAST(NULL AS INTEGER)	AS ALS_SCN,
	ILSATSCN		AS ILS_SCN,
	DIAG_CD 		AS DIAG_CD
FROM RIGHTOUTERJOIN
)


SELECT 	INCIDENT_CD 			   AS Incident_#,
	TIME('00:00:00') + ALS_SCN SECONDS AS ALS_Scene_Time,
	TIME('00:00:00') + ILS_SCN SECONDS AS ILS_Scene_Time
FROM 	RESULTABLE
ORDER BY 1