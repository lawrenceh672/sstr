WITH TOTALS(TOTAL) AS (
SELECT COUNT(*) FROM FACCSDB.PATIENTS1 PS,
FACCSDB.PROCEDURES PR,
FACCSDB.INCIDENTS1 I,
FACCSDB.DIAGNOSIS D

WHERE  PS.PATIENT_CD = PR.PATIENT_CD AND
PS.INCIDENT_CD = PR.INCIDENT_CD AND
I.INCIDENT_CD = PS.INCIDENT_CD AND
PS.DIAG_CD = D.DIAG_CD AND
I.CREATE_DATE BETWEEN DATE('01/31/1998') AND DATE('07/05/1999')
)

SELECT cast (d.diag_cd as integer) as Diag_cd, count(*) as Count, cast((cast(count(*) as float) / cast(total as float)) as dec(5,4)) * 100 as percent

FROM FACCSDB.PATIENTS1 PS,
FACCSDB.PROCEDURES PR,
FACCSDB.INCIDENTS1 I,
FACCSDB.DIAGNOSIS D, totals

WHERE 
PS.PATIENT_CD = PR.PATIENT_CD AND
PS.INCIDENT_CD = PR.INCIDENT_CD AND
I.INCIDENT_CD = PS.INCIDENT_CD AND
PS.DIAG_CD = D.DIAG_CD AND
I.CREATE_DATE BETWEEN DATE('01/31/1998') AND DATE('07/05/1999')
group by d.diag_cd, total
order by 1,2